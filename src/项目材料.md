# ç¬¬ä¸€æ­¥ï¼šå®‰è£…å¿…è¦çš„è½¯ä»¶

## 1.1 å®‰è£… Docker Desktop

### æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•
```
sudo apt update
```

### å®‰è£…å¿…è¦çš„ä¾èµ–
```
sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
```

### æ·»åŠ  Docker å®˜æ–¹ GPG å¯†é’¥
```
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
```

### æ·»åŠ  Docker ä»“åº“
```
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

### å®‰è£… Docker
```
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io
```

### å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ° docker ç»„ï¼ˆé¿å…æ¯æ¬¡ä½¿ç”¨ sudoï¼‰
```
sudo usermod -aG docker $USER
```

## 1.2 éªŒè¯å®‰è£…

æ‰“å¼€ç»ˆç«¯ï¼ˆå‘½ä»¤è¡Œï¼‰ï¼Œè¿è¡Œï¼š

```bash
docker --version
docker-compose --version
```

## ç¬¬äºŒæ­¥ï¼šåˆ›å»ºé¡¹ç›®ç»“æ„

åˆ›å»ºä¸€ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹ï¼Œæ¯”å¦‚å« `my-app`ï¼š

```bash
mkdir my-app
cd my-app
```

åœ¨æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä»¥ä¸‹ç»“æ„ï¼š

```markdown
my-app/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ app.py
â”‚   â””â”€â”€ requirements.txt
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ database/
â”‚   â””â”€â”€ init.sql
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ start.sh
â”‚   â””â”€â”€ stop.sh
â””â”€â”€ monitoring/
    â””â”€â”€ log-collector.sh
```

## ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºæ•°æ®åº“æœåŠ¡

### 3.1 åˆ›å»ºæ•°æ®åº“åˆå§‹åŒ–æ–‡ä»¶

åœ¨ `database/init.sql`ä¸­ï¼š

```sql
CREATE DATABASE IF NOT EXISTS myapp;
USE myapp;

CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO users (name, email) VALUES 
('å¼ ä¸‰', 'zhangsan@example.com'),
('æå››', 'lisi@example.com');
```

### 3.2 åˆ›å»ºæ•°æ®åº“ Dockerfileï¼ˆè¿™é‡Œç›´æ¥ç”¨å®˜æ–¹é•œåƒï¼‰

æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ MySQL å®˜æ–¹é•œåƒï¼Œä¸éœ€è¦è‡ªå®šä¹‰ Dockerfileã€‚

## ç¬¬å››æ­¥ï¼šåˆ›å»ºåç«¯æœåŠ¡

### 4.1 åˆ›å»ºåç«¯ä¾èµ–æ–‡ä»¶

åœ¨ `backend/requirements.txt`ä¸­ï¼š

```markdown
flask==2.3.3
pymysql==1.1.0
python-dotenv==1.0.0
```

### 4.2 åˆ›å»ºåç«¯åº”ç”¨

åœ¨ `backend/app.py`ä¸­ï¼š

```python
from flask import Flask, jsonify, Response
import pymysql
import os
from flask import request 
from dotenv import load_dotenv

load_dotenv()

app = Flask(__name__)

def get_db_connection():
    try:
        return pymysql.connect(
            host=os.getenv('DB_HOST', 'db'),
            user=os.getenv('DB_USER', 'root'),
            password=os.getenv('DB_PASSWORD', 'password'),
            database=os.getenv('DB_NAME', 'myapp'),
            charset='utf8mb4',
            cursorclass=pymysql.cursors.DictCursor
        )
    except Exception as e:
        print(f"æ•°æ®åº“è¿æ¥é”™è¯¯: {e}")
        return None

@app.after_request
def after_request(response):
    # æ‰‹åŠ¨æ·»åŠ CORSå¤´éƒ¨ï¼Œå…è®¸è·¨åŸŸè®¿é—®
    response.headers.add('Access-Control-Allow-Origin', '*')
    response.headers.add('Access-Control-Allow-Headers', 'Content-Type,Authorization')
    response.headers.add('Access-Control-Allow-Methods', 'GET,PUT,POST,DELETE,OPTIONS')
    return response

@app.route('/')
def hello():
    return jsonify({"message": "æ¬¢è¿æ¥åˆ°æˆ‘çš„åº”ç”¨ï¼"})

@app.route('/users')
def get_users():
    connection = get_db_connection()
    
    if connection is None:
        # è¿”å›æ¨¡æ‹Ÿæ•°æ®
        mock_users = [
            {"id": 1, "name": "å¼ ä¸‰", "email": "zhangsan@example.com", "created_at": "2024-01-01 10:00:00"},
            {"id": 2, "name": "æå››", "email": "lisi@example.com", "created_at": "2024-01-02 11:00:00"}
        ]
        return jsonify(mock_users)
        
    try:
        with connection.cursor() as cursor:
            cursor.execute("SELECT * FROM users")
            users = cursor.fetchall()
            return jsonify(users) if users else jsonify([])
    except Exception as e:
        print(f"æŸ¥è¯¢é”™è¯¯: {e}")
        return jsonify([])
    finally:
        if connection:
            connection.close()

@app.route('/health')
def health_check():
    return jsonify({"status": "healthy"})
@app.route('/add_user', methods=['POST'])
def add_user():
    # 1. è·å– JSON è¯·æ±‚ä½“
    data = request.get_json()

    if not data:
        return jsonify({'error': 'è¯·æ±‚ä½“å¿…é¡»ä¸º JSON æ ¼å¼'}), 400

    name = data.get('name')
    email = data.get('email')

    if not name or not email:
        return jsonify({'error': 'name å’Œ email ä¸ºå¿…å¡«å­—æ®µ'}), 400

    # 2. è¿æ¥æ•°æ®åº“
    connection = get_db_connection()
    if connection is None:
        return jsonify({'error': 'æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ï¼Œè¯·ç¨åå†è¯•'}), 500

    try:
        with connection.cursor() as cursor:
            # 3. æ‰§è¡Œæ’å…¥è¯­å¥
            cursor.execute(
                "INSERT INTO users (name, email) VALUES (%s, %s)",
                (name, email)
            )
        # 4. æäº¤äº‹åŠ¡
        connection.commit()
        return jsonify({
            'message': 'ç”¨æˆ·æ·»åŠ æˆåŠŸ',
            'name': name,
            'email': email
        }), 201
    except Exception as e:
        # 5. å¼‚å¸¸å¤„ç†
        print(f"æ’å…¥ç”¨æˆ·æ•°æ®æ—¶å‡ºé”™: {e}")
        return jsonify({'error': f'æ’å…¥æ•°æ®å¤±è´¥: {str(e)}'}), 500
    finally:
        # 6. ç¡®ä¿è¿æ¥å…³é—­
        if connection:
            connection.close()
if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)


```

## ç¬¬äº”æ­¥ï¼šåˆ›å»ºå‰ç«¯æœåŠ¡

### 5.1 åˆ›å»ºå‰ç«¯é¡µé¢

åœ¨ `frontend/index.html`ä¸­ï¼š

```html
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æˆ‘çš„ä¸‰å±‚åº”ç”¨ - ç”¨æˆ·å±•ç¤º</title>
  <style>
    /* å…¨å±€é‡ç½®ä¸åŸºç¡€æ ·å¼ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333;
    }

    .container {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 600px;
      text-align: center;
    }

    h1 {
      color: #444;
      margin-bottom: 30px;
      font-size: 2rem;
    }

    /* æŒ‰é’®æ ·å¼ */
    .btn {
      background: linear-gradient(45deg, #007bff, #0056b3);
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    /* ç”¨æˆ·åˆ—è¡¨æ ·å¼ */
    .user-list {
      text-align: left;
      margin-top: 20px;
    }

    .user-item {
      background: #f8f9fa;
      padding: 16px;
      margin-bottom: 12px;
      border-radius: 10px;
      border-left: 4px solid #007bff;
      transition: background 0.2s ease;
    }

    .user-item:hover {
      background: #e9ecef;
    }

    .user-name {
      font-weight: bold;
      color: #007bff;
      font-size: 1.1rem;
    }

    .user-email {
      color: #666;
      margin: 4px 0;
    }

    .user-created {
      font-size: 0.9rem;
      color: #888;
    }

    /* åŠ è½½ & é”™è¯¯çŠ¶æ€ */
    .loading,
    .error,
    .no-data {
      margin-top: 20px;
      padding: 16px;
      border-radius: 8px;
      font-style: italic;
    }

    .loading {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .no-data {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸŒŸ æˆ‘çš„ä¸‰å±‚åº”ç”¨æ¼”ç¤º</h1>
    <button class="btn" onclick="loadUsers()">ğŸ“¥ åŠ è½½ç”¨æˆ·æ•°æ®</button>
    <div class="user-list" id="userList">
      <!-- é»˜è®¤æç¤º -->
      <div class="no-data">ğŸ‘ˆ ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åŠ è½½ç”¨æˆ·æ•°æ®</div>
    </div>
  </div>

  <script>
</head>

<body>
  <div class="container">
    <h1>ğŸŒŸ æˆ‘çš„ä¸‰å±‚åº”ç”¨æ¼”ç¤º</h1>
    <button class="btn" onclick="loadUsers()">ğŸ“¥ åŠ è½½ç”¨æˆ·æ•°æ®</button>
    <div class="user-list" id="userList">
      <!-- é»˜è®¤æç¤º -->
      <div class="no-data">ğŸ‘ˆ ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åŠ è½½ç”¨æˆ·æ•°æ®</div>
    </div>
  </div>

  <script>
    async function loadUsers() {
      const userList = document.getElementById('userList');
      userList.innerHTML = '<div class="loading">â³ æ­£åœ¨åŠ è½½ç”¨æˆ·æ•°æ®...</div>';

      try {
        const response = await fetch('http://localhost:5000/users');
        if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
        const users = await response.json();

        if (!users || users.length === 0) {
          userList.innerHTML = '<div class="no-data">ğŸ˜” æš‚æ— ç”¨æˆ·æ•°æ®</div>';
          return;
        }

        let html = '<h3 style="margin: 20px 0 10px 0; color: #333;">ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨ï¼š</h3>';
        users.forEach(user => {
          html += `
            <div class="user-item">
              <div class="user-name">${escapeHtml(user.name)}</div>
              <div class="user-email">${escapeHtml(user.email)}</div>
              <div class="user-created">ğŸ•’ åˆ›å»ºæ—¶é—´: ${escapeHtml(user.created_at)}</div>
            </div>
          `;
        });
        userList.innerHTML = html;

      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        userList.innerHTML = `<div class="error">âŒ åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥: ${escapeHtml(error.message)}</div>`;
      }
    }

    // ç®€å•é˜²æ­¢ XSS çš„ HTML è½¬ä¹‰ï¼ˆå¯æ ¹æ®éœ€è¦å¼•å…¥æ›´å®Œå–„çš„æ–¹æ³•ï¼‰
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // å¯é€‰ï¼šé¡µé¢åŠ è½½æ—¶æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€ï¼ˆè°ƒè¯•ç”¨ï¼Œä¸é˜»å¡ï¼‰
    window.addEventListener('load', () => {
      fetch('http://localhost:5000/health')
        .then(res => res.json())
        .then(data => {
          console.log('âœ… åç«¯å¥åº·çŠ¶æ€:', data);
        })
        .catch(err => {
          console.warn('âš ï¸ å¥åº·æ£€æŸ¥è¯·æ±‚å¤±è´¥ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰:', err);
        });
    });
  </script>
</body>

</html>
```

### 5.2 åˆ›å»ºå‰ç«¯ Dockerfile

åœ¨ `frontend/Dockerfile`ä¸­ï¼š

```dockerfile
FROM nginx:alpine
COPY index.html /usr/share/nginx/html/
EXPOSE 80
```

## ç¬¬å…­æ­¥ï¼šåˆ›å»º docker-compose.yml

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `docker-compose.yml`ï¼š

```yaml
version: '3.8'

services:
  # æ•°æ®åº“æœåŠ¡
  db:
    image: mysql:8.0
    container_name: myapp-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: myapp
    volumes:
      - db_data:/var/lib/mysql
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ppassword"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # åç«¯æœåŠ¡
  backend:
    build: ./backend
    container_name: myapp-backend
    restart: unless-stopped
    environment:
      DB_HOST: db
      DB_USER: root
      DB_PASSWORD: password
      DB_NAME: myapp
    ports:
      - "5000:5000"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # å‰ç«¯æœåŠ¡
  frontend:
    build: ./frontend
    container_name: myapp-frontend
    restart: unless-stopped
    ports:
      - "8080:80"
    depends_on:
      backend:
        condition: service_healthy

volumes:
  db_data:
    driver: local
```

## ç¬¬ä¸ƒæ­¥ï¼šåˆ›å»ºå¯åŠ¨å’Œåœæ­¢è„šæœ¬

### 7.1 åˆ›å»ºå¯åŠ¨è„šæœ¬

åœ¨ `scripts/start.sh`ä¸­ï¼š

```bash
#!/bin/bash

echo "ğŸš€ å¯åŠ¨ä¸‰å±‚åº”ç”¨..."

# æ£€æŸ¥ Docker æ˜¯å¦è¿è¡Œ
if ! docker info > /dev/null 2>&1; then
    echo "âŒ Docker æœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨ Docker Desktop"
    exit 1
fi

# å¯åŠ¨æœåŠ¡
docker-compose up -d

echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 15

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "ğŸ“Š æœåŠ¡çŠ¶æ€ï¼š"
docker-compose ps

echo ""
echo "âœ… åº”ç”¨å·²å¯åŠ¨ï¼"
echo "ğŸŒ å‰ç«¯è®¿é—®: http://localhost:8080"
echo "ğŸ”§ åç«¯ API: http://localhost:5000"
echo "ğŸ—„ï¸ æ•°æ®åº“ç«¯å£: 3306"
echo ""
echo "ğŸ“ æŸ¥çœ‹æ—¥å¿—: docker-compose logs -f"
echo "ğŸ›‘ åœæ­¢æœåŠ¡: ./scripts/stop.sh"
```

### 7.2 åˆ›å»ºåœæ­¢è„šæœ¬

åœ¨ `scripts/stop.sh`ä¸­ï¼š

```bash
#!/bin/bash

echo "ğŸ›‘ åœæ­¢ä¸‰å±‚åº”ç”¨..."
docker-compose down

echo "âœ… åº”ç”¨å·²åœæ­¢ï¼"
echo "ğŸ’¾ æ•°æ®å·²æŒä¹…åŒ–ä¿å­˜åœ¨ Docker volume ä¸­"
```

### 7.3 ç»™è„šæœ¬æ‰§è¡Œæƒé™

```bash
chmod +x scripts/start.sh scripts/stop.sh
```

## ç¬¬å…«æ­¥ï¼šåˆ›å»ºæ—¥å¿—é‡‡é›†è„šæœ¬ï¼ˆåŠ åˆ†é¡¹ï¼‰

åœ¨ `monitoring/log-collector.sh`ä¸­ï¼š

```bash
#!/bin/bash

LOG_DIR="./logs"
mkdir -p "$LOG_DIR"

echo "ğŸ“‹ å¼€å§‹æ”¶é›†æ—¥å¿—..."

# æ”¶é›†å„æœåŠ¡æ—¥å¿—
docker-compose logs db > "$LOG_DIR/db.log" 2>&1
docker-compose logs backend > "$LOG_DIR/backend.log" 2>&1
docker-compose logs frontend > "$LOG_DIR/frontend.log" 2>&1

# ç”Ÿæˆæ—¥å¿—æ‘˜è¦
echo "=== æ—¥å¿—æ‘˜è¦ $(date) ===" > "$LOG_DIR/summary.log"
echo "æ•°æ®åº“æ—¥å¿—è¡Œæ•°: $(wc -l < "$LOG_DIR/db.log")" >> "$LOG_DIR/summary.log"
echo "åç«¯æ—¥å¿—è¡Œæ•°: $(wc -l < "$LOG_DIR/backend.log")" >> "$LOG_DIR/summary.log"
echo "å‰ç«¯æ—¥å¿—è¡Œæ•°: $(wc -l < "$LOG_DIR/frontend.log")" >> "$LOG_DIR/summary.log"

echo "âœ… æ—¥å¿—å·²ä¿å­˜åˆ° $LOG_DIR ç›®å½•"
echo "ğŸ“Š æŸ¥çœ‹æ‘˜è¦: cat $LOG_DIR/summary.log"
```

ç»™æ‰§è¡Œæƒé™ï¼š

```bash
chmod +x monitoring/log-collector.sh
```

## ç¬¬ä¹æ­¥ï¼šå¯åŠ¨å’Œæµ‹è¯•åº”ç”¨

### 9.1 å¯åŠ¨åº”ç”¨

```bash
./scripts/start.sh
```

### 9.2 éªŒè¯æ•°æ®åº“æŒä¹…åŒ–

1. 

   æ‰“å¼€æµè§ˆå™¨è®¿é—® http://localhost:8080

2. 

   ç‚¹å‡»"åŠ è½½ç”¨æˆ·æ•°æ®"æŒ‰é’®ï¼Œåº”è¯¥èƒ½çœ‹åˆ°ä¸¤ä¸ªç”¨æˆ·

3. 

   åœæ­¢åº”ç”¨ï¼š`docker-compose down`

4. 

   é‡æ–°å¯åŠ¨ï¼š`./scripts/start.sh`

5. 

   å†æ¬¡è®¿é—®å‰ç«¯ï¼Œæ•°æ®ä»ç„¶å­˜åœ¨ï¼ˆè¯æ˜æŒä¹…åŒ–æˆåŠŸï¼‰

### 9.3 éªŒè¯å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥å„æœåŠ¡å¥åº·çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹è¯¦ç»†å¥åº·çŠ¶æ€
docker inspect --format='{{.State.Health.Status}}' myapp-db
docker inspect --format='{{.State.Health.Status}}' myapp-backend
```

### 9.4 æµ‹è¯•æ—¥å¿—é‡‡é›†

```bash
./monitoring/log-collector.sh
cat logs/summary.log
```